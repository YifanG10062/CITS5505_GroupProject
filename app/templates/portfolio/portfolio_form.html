{% extends "base.html" %}

{% block title %}{{ 'Edit' if portfolio else 'Create New' }} Portfolio - The Richverse{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/portfolio-form.css') }}">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="page-heading mb-1">Build your Portfolio in <span class="richverse-title">THE RICHVERSE</span></h1>
        <p class="page-subheading">Travel back to <span class="highlight">1/1/2015</span> with <span class="highlight">$1,000</span>, pick up to <span class="highlight">3 assets</span>, and see your gains today!</p>
    </div>
</div>

<form method="POST" action="{{ url_for('portfolios.edit', portfolio_id=portfolio.portfolio_id) if portfolio else url_for('portfolios.create') }}" id="portfolio-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="row">
        <!-- Asset Selection -->
        <div class="col-12 col-lg-8 order-1">
            <div class="asset-grid">
                {% for asset in assets %}
                <div class="asset-card" data-asset-code="{{ asset.code }}">
                    <div class="asset-icon">
                        <img src="{{ asset.logo_url }}" alt="{{ asset.name }}">
                    </div>
                    <div class="asset-name">{{ asset.name }}</div>
                    <div class="asset-company">{{ asset.company }}</div>
                    <div class="selection-indicator">
                        <i class="bi bi-check"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Portfolio Configuration Sidebar -->
        <div class="col-12 col-lg-4 order-2">
            <div class="card">
                <div class="card-body">
                    <!-- Initial Amount -->
                    <div class="mb-3">
                        <label for="initial_amount" class="form-label">Initial Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="initial_amount" name="initial_amount" 
                                   value="{{ portfolio.initial_amount if portfolio else 1000 }}" readonly>
                        </div>
                    </div>
                    
                    <!-- Start Date -->
                    <div class="mb-3">
                        <label for="start_date" class="form-label">Start from</label>
                        <input type="text" class="form-control" id="start_date" name="start_date" 
                               value="1/1/2018" readonly>
                    </div>
                    
                    <!-- Asset Allocation -->
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            <span>Allocation</span>
                            <span class="allocation-total invalid" id="allocation-total">0%</span>
                        </label>
                        
                        <div id="allocation-container" class="card">
                            <div id="no-assets" class="no-assets">
                                <div class="no-assets-icon">
                                    <i class="bi bi-bar-chart"></i>
                                </div>
                                <p>Select at least one asset</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Name -->
                    <div class="mb-4">
                        <label for="portfolio_name" class="form-label">Portfolio name</label>
                        <input type="text" class="form-control" id="portfolio_name" name="portfolio_name" 
                               placeholder="Click to edit" value="{{ portfolio.name if portfolio else '' }}" required maxlength="50">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('portfolios.list') }}" class="btn btn-outline-secondary flex-grow-1">
                            cancel
                        </a>
                        <button type="submit" class="btn btn-primary flex-grow-1" id="create-portfolio-btn" disabled>
                            {{ 'Update Portfolio' if portfolio else 'Create Portfolio' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Asset selection logic
    const MAX_ASSETS = 3;
    const assetCards = document.querySelectorAll('.asset-card');
    const allocationContainer = document.getElementById('allocation-container');
    const noAssetsDiv = document.getElementById('no-assets');
    const totalAllocationDisplay = document.getElementById('allocation-total');
    const createButton = document.getElementById('create-portfolio-btn');
    
    // Track selected assets and allocations
    let selectedAssets = [];
    let allocations = {};
    
    // Asset card click handler
    assetCards.forEach(card => {
        card.addEventListener('click', function() {
            const assetCode = this.dataset.assetCode;
            const assetName = this.querySelector('.asset-name').innerText;
            const assetCompany = this.querySelector('.asset-company').innerText;
            const assetLogoSrc = this.querySelector('.asset-icon img').src;
            
            if (this.classList.contains('selected')) {
                // Remove asset
                this.classList.remove('selected');
                removeAssetAllocation(assetCode);
                selectedAssets = selectedAssets.filter(asset => asset.code !== assetCode);
            } else {
                // Add asset if under limit
                if (selectedAssets.length < MAX_ASSETS) {
                    this.classList.add('selected');
                    selectedAssets.push({
                        code: assetCode,
                        name: assetName,
                        company: assetCompany,
                        logoSrc: assetLogoSrc
                    });
                    addAssetAllocation(assetCode, assetName, assetLogoSrc);
                }
            }
            
            // Update UI based on selection
            updateAllocationUI();
        });
    });
    
    // Add asset allocation UI
    function addAssetAllocation(assetCode, assetName, logoSrc) {
        // Default allocation value logic based on the spec in the design notes
        let defaultValue = 0;
        switch (selectedAssets.length) {
            case 1: defaultValue = 100; break;
            case 2: defaultValue = 50; break;
            case 3: defaultValue = 33; break;
        }
        
        // Update allocations for all assets
        if (selectedAssets.length === 1) {
            allocations[assetCode] = 100;
        } else if (selectedAssets.length === 2) {
            // Reset to 50/50
            const keys = Object.keys(allocations);
            keys.forEach(key => allocations[key] = 50);
            allocations[assetCode] = 50;
        } else if (selectedAssets.length === 3) {
            // Reset to 33/33/34
            const keys = Object.keys(allocations);
            keys.forEach((key, index) => {
                allocations[key] = index === 2 ? 34 : 33;
            });
            allocations[assetCode] = 33;
        }
        
        // Create allocation items
        updateAllocationItems();
    }
    
    // Remove asset allocation
    function removeAssetAllocation(assetCode) {
        delete allocations[assetCode];
        
        // Redistribute allocations
        const remainingAssets = Object.keys(allocations);
        if (remainingAssets.length === 1) {
            allocations[remainingAssets[0]] = 100;
        } else if (remainingAssets.length === 2) {
            allocations[remainingAssets[0]] = 50;
            allocations[remainingAssets[1]] = 50;
        }
        
        updateAllocationItems();
    }
    
    // Update all allocation UI elements
    function updateAllocationUI() {
        if (selectedAssets.length === 0) {
            noAssetsDiv.style.display = 'block';
            createButton.disabled = true;
            totalAllocationDisplay.textContent = '0%';
            totalAllocationDisplay.classList.replace('valid', 'invalid');
        } else {
            noAssetsDiv.style.display = 'none';
            const total = calculateTotalAllocation();
            totalAllocationDisplay.textContent = `${total}%`;
            
            if (total === 100) {
                totalAllocationDisplay.classList.replace('invalid', 'valid');
                createButton.disabled = false;
            } else {
                totalAllocationDisplay.classList.replace('valid', 'invalid');
                createButton.disabled = true;
            }
        }
    }
    
    // Calculate total allocation
    function calculateTotalAllocation() {
        return Object.values(allocations).reduce((sum, value) => sum + value, 0);
    }
    
    // Update allocation items in the UI
    function updateAllocationItems() {
        // Clear existing items (except the no-assets div)
        const existingItems = allocationContainer.querySelectorAll('.allocation-item');
        existingItems.forEach(item => item.remove());
        
        // Create items for each selected asset
        selectedAssets.forEach(asset => {
            const allocation = allocations[asset.code];
            
            const allocationItem = document.createElement('div');
            allocationItem.className = 'allocation-item';
            allocationItem.dataset.assetCode = asset.code;
            
            allocationItem.innerHTML = `
                <div class="allocation-asset">
                    <img src="${asset.logoSrc}" class="asset-icon-sm" alt="${asset.name}">
                    <div class="allocation-name">${asset.name}</div>
                </div>
                <div class="allocation-control">
                    <div class="allocation-input">
                        <input type="range" class="form-range" min="0" max="100" step="1" 
                               value="${allocation}" data-asset-code="${asset.code}">
                        <input type="number" class="form-control" min="0" max="100" 
                               name="allocation[${asset.code}]" value="${allocation}" required>
                        <span class="percentage">%</span>
                    </div>
                </div>
            `;
            
            allocationContainer.appendChild(allocationItem);
            
            // Add event listeners to the new controls
            const rangeInput = allocationItem.querySelector('.form-range');
            const numberInput = allocationItem.querySelector('.form-control');
            
            rangeInput.addEventListener('input', function() {
                numberInput.value = this.value;
                allocations[asset.code] = parseInt(this.value);
                updateAllocationUI();
            });
            
            numberInput.addEventListener('input', function() {
                rangeInput.value = this.value;
                allocations[asset.code] = parseInt(this.value);
                updateAllocationUI();
            });
        });
        
        updateAllocationUI();
    }
    
    // Form validation
    document.getElementById('portfolio-form').addEventListener('submit', function(e) {
        const total = calculateTotalAllocation();
        if (total !== 100) {
            e.preventDefault();
            alert('Total allocation must equal 100%');
            return false;
        }
        
        const portfolioName = document.getElementById('portfolio_name').value.trim();
        if (!portfolioName) {
            e.preventDefault();
            alert('Please provide a portfolio name');
            return false;
        }
        
        if (selectedAssets.length === 0) {
            e.preventDefault();
            alert('Please select at least one asset');
            return false;
        }
        
        // Set portfolio name based on assets if not specified
        if (portfolioName === '') {
            const assetCodes = selectedAssets.map(asset => asset.code);
            document.getElementById('portfolio_name').value = `${assetCodes.join('/')}_portfolio`;
        }
    });
});
</script>
{% endblock %}
