<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if portfolio %}Edit{% else %}New{% endif %} Portfolio</title>
</head>
<body>
    <h1>{% if portfolio %}Edit{% else %}Create New{% endif %} Portfolio</h1>

    <form method="post" onsubmit="prepareAllocationJson()">
        <!-- Display Initial Amount (Read-only) -->
        <div>
            <label>Initial Amount:</label>
            <input type="text" value="1000.00" readonly>
        </div>

        <!-- Display Start Date (Read-only) -->
        <div>
            <label>Start Date:</label>
            <input type="text" value="2020-01-01" readonly>
        </div>

        <hr>

        <!-- Portfolio Name Input -->
        <div>
            <label>Portfolio Name:</label>
            <input type="text" name="portfolio_name" value="{{ portfolio.name if portfolio else '' }}" required>
        </div>

        <hr>

        <!-- Allocation Section -->
        <div id="allocations">
            <label>Allocations:</label>
            <!-- Example allocation entry -->
            <div class="allocation-entry">
                <input type="number" name="percentage_temp" placeholder="%" min="0" max="100" step="1" required>
                <select name="stock_temp" required>
                    <option value="">Select Stock</option>
                    <option value="BTC">BTC</option>
                    <option value="NVDA">NVDA</option>
                    <!-- Future: populate dynamically -->
                </select>
                <button type="button" onclick="removeAllocation(this)">Delete</button>
            </div>
        </div>

        <!-- Add New Allocation Row -->
        <button type="button" onclick="addAllocation()">+ Add Allocation</button>

        <!-- Hidden input to store allocation JSON -->
        <input type="hidden" name="allocation_json" id="allocation_json">

        <br><br>

        <!-- Form Action Buttons -->
        <button type="button" onclick="window.history.back()">Cancel</button>
        <button type="submit">Save</button>
    </form>

    <script>
        // Function to add a new allocation row
        function addAllocation() {
            const container = document.getElementById('allocations');
            const newEntry = document.createElement('div');
            newEntry.className = 'allocation-entry';
            newEntry.innerHTML = `
                <input type="number" name="percentage_temp" placeholder="%" min="0" max="100" step="1" required>
                <select name="stock_temp" required>
                    <option value="">Select Stock</option>
                    <option value="BTC">BTC</option>
                    <option value="NVDA">NVDA</option>
                </select>
                <button type="button" onclick="removeAllocation(this)">Delete</button>
            `;
            container.appendChild(newEntry);
        }

        // Function to remove an allocation row
        function removeAllocation(button) {
            button.parentElement.remove();
        }

        // Function to prepare JSON before submitting
        function prepareAllocationJson() {
            const percentages = document.getElementsByName('percentage_temp');
            const stocks = document.getElementsByName('stock_temp');
            const allocation = {};

            for (let i = 0; i < percentages.length; i++) {
                const stock = stocks[i].value;
                const percent = parseFloat(percentages[i].value) / 100.0;
                if (stock && !isNaN(percent)) {
                    allocation[stock] = percent;
                }
            }

            document.getElementById('allocation_json').value = JSON.stringify(allocation);
        }
    </script>
</body>
</html>
